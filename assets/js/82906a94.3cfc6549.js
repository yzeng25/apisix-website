"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[31363],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),c=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return i.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(n),d=a,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||r;return n?i.createElement(h,o(o({ref:t},p),{},{components:n})):i.createElement(h,o({ref:t},p))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<r;c++)o[c]=n[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},68521:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var i=n(87462),a=(n(67294),n(3905));const r={title:"Configure mTLS for client to APISIX",keywords:["mTLS","API Gateway","APISIX"],description:"This article describes how to configure mutual authentication (mTLS) between the client and Apache APISIX."},o=void 0,l={unversionedId:"tutorials/client-to-apisix-mtls",id:"version-3.1/tutorials/client-to-apisix-mtls",isDocsHomePage:!1,title:"Configure mTLS for client to APISIX",description:"This article describes how to configure mutual authentication (mTLS) between the client and Apache APISIX.",source:"@site/docs-apisix_versioned_docs/version-3.1/tutorials/client-to-apisix-mtls.md",sourceDirName:"tutorials",slug:"/tutorials/client-to-apisix-mtls",permalink:"/docs/apisix/3.1/tutorials/client-to-apisix-mtls",editUrl:"/edit#https://github.com/apache/apisix/edit/release/3.1/docs/en/latest/tutorials/client-to-apisix-mtls.md",tags:[],version:"3.1",frontMatter:{title:"Configure mTLS for client to APISIX",keywords:["mTLS","API Gateway","APISIX"],description:"This article describes how to configure mutual authentication (mTLS) between the client and Apache APISIX."},sidebar:"version-3.1/docs",previous:{title:"Health Check",permalink:"/docs/apisix/3.1/tutorials/health-check"},next:{title:"API Gateway",permalink:"/docs/apisix/3.1/terminology/api-gateway"}},s=[{value:"Configuration",id:"configuration",children:[{value:"Generate certificates",id:"generate-certificates",children:[]},{value:"Configure the certificate in APISIX",id:"configure-the-certificate-in-apisix",children:[]},{value:"Configure the route in APISIX",id:"configure-the-route-in-apisix",children:[]},{value:"Test",id:"test",children:[]}]},{value:"Conclusion",id:"conclusion",children:[]}],c={toc:s};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"mTLS is a method for mutual authentication. Suppose in your network environment, only trusted clients are required to access the server. In that case, you can enable mTLS to verify the client's identity and ensure the server API's security. This article mainly introduces how to configure mutual authentication (mTLS) between the client and Apache APISIX."),(0,a.kt)("h2",{id:"configuration"},"Configuration"),(0,a.kt)("p",null,"This example includes the following procedures:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Generate certificates;"),(0,a.kt)("li",{parentName:"ol"},"Configure the certificate in APISIX;"),(0,a.kt)("li",{parentName:"ol"},"Create and configure routes in APISIX;"),(0,a.kt)("li",{parentName:"ol"},"Test verification.")),(0,a.kt)("p",null,"To make the test results clearer, the examples mentioned in this article pass some information about the client credentials upstream, including: ",(0,a.kt)("inlineCode",{parentName:"p"},"serial"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"fingerprint")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"common name"),"."),(0,a.kt)("h3",{id:"generate-certificates"},"Generate certificates"),(0,a.kt)("p",null,"We need to generate three test certificates: the root, server, and client. Just use the following command to generate the test certificates we need via ",(0,a.kt)("inlineCode",{parentName:"p"},"OpenSSL"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'# For ROOT CA\nopenssl genrsa -out ca.key 2048\nopenssl req -new -sha256 -key ca.key -out ca.csr -subj "/CN=ROOTCA"\nopenssl x509 -req -days 36500 -sha256 -extensions v3_ca -signkey ca.key -in ca.csr -out ca.cer\n\n# For server certificate\nopenssl genrsa -out server.key 2048\n# Note: The `test.com` in the CN value is the domain name/hostname we want to test\nopenssl req -new -sha256 -key server.key -out server.csr -subj "/CN=test.com"\nopenssl x509 -req -days 36500 -sha256 -extensions v3_req  -CA  ca.cer -CAkey ca.key  -CAserial ca.srl  -CAcreateserial -in server.csr -out server.cer\n\n# For client certificate\nopenssl genrsa -out client.key 2048\nopenssl req -new -sha256 -key client.key  -out client.csr -subj "/CN=CLIENT"\nopenssl x509 -req -days 36500 -sha256 -extensions v3_req  -CA  ca.cer -CAkey ca.key  -CAserial ca.srl  -CAcreateserial -in client.csr -out client.cer\n\n# Convert client certificate to pkcs12 for Windows usage (optional)\nopenssl pkcs12 -export -clcerts -in client.cer -inkey client.key -out client.p12\n')),(0,a.kt)("h3",{id:"configure-the-certificate-in-apisix"},"Configure the certificate in APISIX"),(0,a.kt)("p",null,"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," command to request APISIX Admin API to set up SSL for specific SNI."),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"Note that the newline character in the certificate needs to be replaced with its escape character ",(0,a.kt)("inlineCode",{parentName:"p"},"\\n"),"."))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X PUT \'http://127.0.0.1:9180/apisix/admin/ssls/1\' \\\n--header \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' \\\n--header \'Content-Type: application/json\' \\\n--data-raw \'{\n    "sni": "test.com",\n    "cert": "<content of server.cer>",\n    "key": "<content of server.key>",\n    "client": {\n        "ca": "<content of ca.cer>"\n    }\n}\'\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"sni"),": Specify the domain name (CN) of the certificate. When the client tries to handshake with APISIX via TLS, APISIX will match the SNI data in ",(0,a.kt)("inlineCode",{parentName:"li"},"ClientHello")," with this field and find the corresponding server certificate for handshaking."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"cert"),": The public key of the server certificate."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"key"),": The private key of the server certificate."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"client.ca"),": The public key of the client's certificate. For demonstration purposes, the same ",(0,a.kt)("inlineCode",{parentName:"li"},"CA")," is used here.")),(0,a.kt)("h3",{id:"configure-the-route-in-apisix"},"Configure the route in APISIX"),(0,a.kt)("p",null,"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," command to request the APISIX Admin API to create a route."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X PUT \'http://127.0.0.1:9180/apisix/admin/routes/1\' \\\n--header \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' \\\n--header \'Content-Type: application/json\' \\\n--data-raw \'{\n    "uri": "/anything",\n    "plugins": {\n        "proxy-rewrite": {\n            "headers": {\n                "X-Ssl-Client-Fingerprint": "$ssl_client_fingerprint",\n                "X-Ssl-Client-Serial": "$ssl_client_serial",\n                "X-Ssl-Client-S-DN": "$ssl_client_s_dn"\n            }\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "httpbin.org":1\n        },\n        "type":"roundrobin"\n    }\n}\'\n')),(0,a.kt)("p",null,"APISIX automatically handles the TLS handshake based on the SNI and the SSL resource created in the previous step, so we do not need to specify the hostname in the route (but it is possible to specify the hostname if you need it)."),(0,a.kt)("p",null,"Also, in the ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," command above, we enabled the ",(0,a.kt)("a",{parentName:"p",href:"/docs/apisix/3.1/plugins/proxy-rewrite"},"proxy-rewrite")," plugin, which will dynamically update the request header information. The source of the variable values in the example are the ",(0,a.kt)("inlineCode",{parentName:"p"},"NGINX")," variables, and you can find them here: ",(0,a.kt)("a",{parentName:"p",href:"http://nginx.org/en/docs/http/ngx_http_ssl_module.html#variables"},"http://nginx.org/en/docs/http/ngx_http_ssl_module.html#variables"),"."),(0,a.kt)("h3",{id:"test"},"Test"),(0,a.kt)("p",null,"Since we are using the domain ",(0,a.kt)("inlineCode",{parentName:"p"},"test.com")," as the test domain, we have to add the test domain to your DNS or local ",(0,a.kt)("inlineCode",{parentName:"p"},"hosts")," file before we can start the verification."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"If we don't use ",(0,a.kt)("inlineCode",{parentName:"li"},"hosts")," and just want to test the results, then you can do so directly using the following command.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'curl --resolve "test.com:9443:127.0.0.1" https://test.com:9443/anything -k --cert ./client.cer --key ./client.key\n')),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"If you need to modify ",(0,a.kt)("inlineCode",{parentName:"li"},"hosts"),", please read the following example (for Ubuntu).")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Modify the ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/hosts")," file"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"# 127.0.0.1 localhost\n127.0.0.1 test.com\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Verify that the test domain name is valid"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ping test.com\n\nPING test.com (127.0.0.1) 56(84) bytes of data.\n64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=1 ttl=64 time=0.028 ms\n64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=2 ttl=64 time=0.037 ms\n64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=3 ttl=64 time=0.036 ms\n64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=4 ttl=64 time=0.031 ms\n^C\n--- test.com ping statistics ---\n4 packets transmitted, 4 received, 0% packet loss, time 3080ms\nrtt min/avg/max/mdev = 0.028/0.033/0.037/0.003 ms\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Test results"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"curl https://test.com:9443/anything -k --cert ./client.cer --key ./client.key\n")),(0,a.kt)("p",{parentName:"li"},"You will then receive the following response body."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {},\n  "headers": {\n    "Accept": "*/*",\n    "Host": "test.com",\n    "User-Agent": "curl/7.81.0",\n    "X-Amzn-Trace-Id": "Root=1-63256343-17e870ca1d8f72dc40b2c5a9",\n    "X-Forwarded-Host": "test.com",\n    "X-Ssl-Client-Fingerprint": "c1626ce3bca723f187d04e3757f1d000ca62d651",\n    "X-Ssl-Client-S-Dn": "CN=CLIENT",\n    "X-Ssl-Client-Serial": "5141CC6F5E2B4BA31746D7DBFE9BA81F069CF970"\n  },\n  "json": null,\n  "method": "GET",\n  "origin": "127.0.0.1",\n  "url": "http://test.com/anything"\n}\n')))),(0,a.kt)("p",null,"Since we configured the ",(0,a.kt)("a",{parentName:"p",href:"/docs/apisix/3.1/plugins/proxy-rewrite"},"proxy-rewrite")," plugin in the example, we can see that the response body contains the request body received upstream, containing the correct data."),(0,a.kt)("h2",{id:"conclusion"},"Conclusion"),(0,a.kt)("p",null,"If you don't want to use curl or test on windows, you can read this gist for more details. ",(0,a.kt)("a",{parentName:"p",href:"https://gist.github.com/bzp2010/6ce0bf7c15c191029ed54724547195b4"},"APISIX mTLS for client to APISIX"),"."),(0,a.kt)("p",null,"For more information about the mTLS feature of Apache APISIX, you can read ",(0,a.kt)("a",{parentName:"p",href:"/docs/apisix/3.1/mtls"},"Mutual TLS Authentication"),"."))}p.isMDXComponent=!0}}]);